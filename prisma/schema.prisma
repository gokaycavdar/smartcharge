// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String   // Hash'lenmiÅŸ ÅŸifre
  role      String   @default("DRIVER") // "DRIVER" | "OPERATOR"
  
  // Gamification & Stats
  coins     Int      @default(0)
  co2Saved  Float    @default(0.0) // Toplam tasarruf (kg)
  xp        Int      @default(0)   // Level sistemi iÃ§in puan

  // Ä°liÅŸkiler
  reservations Reservation[]
  stations     Station[]
  badges       Badge[]       // KazanÄ±lan rozetler
  campaigns    Campaign[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Campaign {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  status      String   @default("DRAFT") // "ACTIVE" | "DRAFT" | "ENDED"
  target      String
  discount    String
  endDate     DateTime?
  
  ownerId     Int
  owner       User     @relation(fields: [ownerId], references: [id])

  // Ä°steÄŸe baÄŸlÄ±: Belirli bir istasyona Ã¶zel kampanya
  stationId   Int?
  station     Station? @relation(fields: [stationId], references: [id])
  
  coinReward  Int      @default(0) // Kampanya ile kazanÄ±lacak ekstra coin

  // Hedef badge'ler - bu badge'lere sahip kullanÄ±cÄ±lara gÃ¶sterilecek
  targetBadges Badge[] @relation("CampaignTargetBadges")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Badge {
  id          Int     @id @default(autoincrement())
  name        String  // Ã–rn: "Gece KuÅŸu"
  description String  // Ã–rn: "Gece 02:00-05:00 arasÄ± 3 kez ÅŸarj et"
  icon        String  // Emoji veya icon adÄ± (Ã¶rn: "ðŸ¦‰")
  users       User[]
  // Bu badge'i hedefleyen kampanyalar
  targetedCampaigns Campaign[] @relation("CampaignTargetBadges")
}

model Station {
  id          Int      @id @default(autoincrement())
  name        String
  lat         Float
  lng         Float
  address     String?
  price       Float    @default(5.0)
  density     Int      @default(0) // 0-100 arasÄ± yoÄŸunluk (0: BoÅŸ, 100: Dolu)
  ownerId     Int?
  
  // Ä°stasyon yoÄŸunluk profili: "central" | "suburban" | "outskirt"
  // Merkezi istasyonlar daha yoÄŸun, kenar istasyonlar daha boÅŸ
  densityProfile String @default("suburban")
  
  owner       User?    @relation(fields: [ownerId], references: [id])
  reservations Reservation[]
  campaigns    Campaign[]
  densityForecasts StationDensityForecast[]
}

// HaftalÄ±k yoÄŸunluk tahmin tablosu (Linear Regression ile oluÅŸturulacak)
model StationDensityForecast {
  id            Int      @id @default(autoincrement())
  stationId     Int
  dayOfWeek     Int      // 0-6 (0: Pazartesi, 6: Pazar)
  hour          Int      // 0-23
  predictedLoad Int      // 0-100 arasÄ± tahmin edilen yoÄŸunluk
  
  station       Station  @relation(fields: [stationId], references: [id])
  updatedAt     DateTime @updatedAt

  @@unique([stationId, dayOfWeek, hour])
}

model Reservation {
  id        Int      @id @default(autoincrement())
  userId    Int
  stationId Int
  date      DateTime
  hour      String   
  isGreen   Boolean  @default(false)
  
  // Bu ÅŸarjdan kazanÄ±lanlar
  earnedCoins Int      @default(0)
  savedCo2    Float    @default(0.0) // Bu iÅŸlemdeki CO2 tasarrufu

  status    String   @default("PENDING")

  user    User    @relation(fields: [userId], references: [id])
  station Station @relation(fields: [stationId], references: [id])
}